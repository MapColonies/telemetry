# Telemetry
## Semantic Conventions
* This package goal is to provide flexible and easy to provide semantic conventions to be used for telemetry purposes across all of MapColonies services.
* Its based on OpenTelemetry [semantic-conventions](https://opentelemetry.io/docs/specs/semconv/).
* Each Domain define its own domain.json and pass it to validation & auto-generate Typescripts types and code.
* Support Javascript & Typescript compatibility

## example
Below are short examples for schema definition and domain.json files.

### Some json-schema definition
```json
{
  "$schema": "http://json-schema.org/draft-07/schema",
  "type": "object",
  "additionalProperties": false,
  "title": "cat family hierarchy schema",
  "required": ["clan", "content"],
  "properties": {
    "clan": {
      "type": "string"
    },
    "content": {
      "$ref": "#/definitions/recursive"
    }
  },
  "definitions": {
    "recursive": {
      "type": "object",
      "additionalProperties": false,
      "title": "clan tree",
      "required": ["propertyName", "description"],
      "properties": {
        "propertyName": {
          "type": "string"
        },
        "kind": {
          "type": "string"
        },
        "description": {
          "type": "string"
        },
        "deprecated": {
          "type": "boolean"
        },
        "subAttributes": {
          "type": "object",
          "additionalProperties": {
            "$ref": "#/definitions/recursive"
          }
        }
      }
    }
  }
}
```

### Convert json-schema definition into typescripts
running CLI (json2ts)

```bash
 npx json2ts schemas/cats.schema.json > scripts/cats.mts
```

Will expect ts autogenerated module with types

```typescript
/* eslint-disable */
/**
 * This file was automatically generated by json-schema-to-typescript.
 * DO NOT MODIFY IT BY HAND. Instead, modify the source JSONSchema file,
 * and run json-schema-to-typescript to regenerate this file.
 */

export interface ConventionSchema {
  domain?: string;
  content: AttributeDescription;
}
export interface AttributeDescription {
  propertyName: string;
  kind?: string;
  description: string;
  deprecated?: boolean;
  subAttributes?: {
    [k: string]: AttributeDescription;
  };
}
```

New domain definition according to json-schema
```json
{
  "domain": "scottish",
  "content": {
    "propertyName": "mapcolonies.scottish",
    "kind": "clan",
    "description": "name of the clan",
    "deprecated": false,
    "subAttributes": {
      "straight": {
        "propertyName": "mapcolonies.scottish.straight",
        "kind": "straightAttributes",
        "description": "attributes related to straights",
        "deprecated": false,
        "subAttributes": {
          "Jimmy": {
            "propertyName": "mapcolonies.scottish.straight.jimmy",
            "deprecated": false,
            "description": "Jimmy the scottish straight cat"
          },
          "David": {
            "propertyName": "mapcolonies.scottish.straight.david",
            "deprecated": false,
            "description": "David the scottish straight cat"
          }
        }
      },
      "fold": {
        "propertyName": "mapcolonies.scottish.fold",
        "kind": "straightAttributes",
        "description": "attributes related to fold",
        "deprecated": false,
        "subAttributes": {
          "Freddy": {
            "propertyName": "mapcolonies.scottish.fold.freddy",
            "deprecated": false,
            "description": "Freddy the scottish fold cat"
          },
          "Louis": {
            "propertyName": "mapcolonies.scottish.fold.louis",
            "deprecated": false,
            "description": "Louis the scottish straight cat"
          }
        }
      }
    }
  }
}
```
### Generate auto constants
Run validation to assert the new domain suite the json-schema definition

```bash
node --import=tsimp/import scripts/validate-semantic-conventions.mts
```

Run attributes generation to create new ts modules for all defined domain.json files

```bash
node --import=tsimp/import scripts/build-semantic-conventions.mts
```

#### Expected new module 'SCOTTISH_GENERATED_ATTRIBUTES.ts'
```typescript
/* eslint-disable */
/**
 * This file was automatically generated by @mapcolonies/telemetry npm package.
 * DO NOT MODIFY IT BY HAND. Instead, modify the source JSONSchema file,
 * and release new compiled package to regenerate this file.
 */

/**
* Louis the scottish straight cat
* @constant
*/
export const SCOTTISH_FOLD_LOUIS = 'mapcolonies.scottish.fold.louis'

/**
* Freddy the scottish fold cat
* @constant
*/
export const SCOTTISH_FOLD_FREDDY = 'mapcolonies.scottish.fold.freddy'

/**
* David the scottish straight cat
* @constant
*/
export const SCOTTISH_STRAIGHT_DAVID = 'mapcolonies.scottish.straight.david'

/**
* Jimmy the scottish straight cat
* @constant
*/
export const SCOTTISH_STRAIGHT_JIMMY = 'mapcolonies.scottish.straight.jimmy'

/**
* name of the clan
* @constant
*/
export const SCOTTISH_CONVENTIONS = {
  scottish: {
    fold: {
      Louis: 'mapcolonies.scottish.fold.louis',
      Freddy: 'mapcolonies.scottish.fold.freddy'
    },
    straight: {
      David: 'mapcolonies.scottish.straight.david',
      Jimmy: 'mapcolonies.scottish.straight.jimmy'
    }
  }
}
```
<br/>

## CI

*Type generation, validation and attributes generation occur automatically as part of pre-build stage*

<br/>

## USAGE
After publishing new package version with new domain - how to use from package:

1.
```bash 
npm i @map-colonies/telemetry
 ```

import

2.
 ```typescript
import { SCOTTISH_CONVENTIONS, SCOTTISH_FOLD_LOUIS } from '@map-colonies/telemetry/conventions';
console.log(SCOTTISH_CONVENTIONS.scottish.straight.David)
console.log(SCOTTISH_FOLD_LOUIS)
```

