# Telemetry Semantic Conventions
* This submodule goal is to provide flexible and easy to provide semantic conventions to be used for telemetry purposes across all of MapColonies services.
* It's based on OpenTelemetry [semantic-conventions](https://opentelemetry.io/docs/specs/semconv/).
* Each Domain defines its JSON file that describes the semantic conventions of the domain. The submodule handles the validation of the file and the generation of files for use in code.
* Support Javascript & Typescript.

> [!IMPORTANT]
> If OpenTelemetry already defined a value as part of their semantic conventions, use that and do not define a new one.

> [!IMPORTANT]
> Attributes should follow the Open Telemetry [semantic-convention naming concept](https://github.com/open-telemetry/semantic-conventions/blob/main/docs/messaging/messaging-spans.md#message)

## USAGE

1. Install the package using the following command:
   
```bash 
npm i @map-colonies/telemetry
 ```

2. Import the package and the use the conventions as needed.
 ```typescript
import { SCOTTISH_CONVENTIONS, SCOTTISH_FOLD } from '@map-colonies/telemetry/conventions';

console.log(SCOTTISH_CONVENTIONS.scottish.straight.David)
console.log(SCOTTISH_FOLD) // This will be marked with strikethrough because it's marked as deprecated
```

> [!IMPORTANT]
> If when using the package you get any errors of missing type definitions, or unable to import the submodule `conventions`, you should make sure both the `module` and `moduleResolution` options of your `tsconfig` / `jsconfig` are set to `NodeNext`. [For more information](https://www.typescriptlang.org/tsconfig#moduleResolution).

## Domain creation
Below is a short example of creation of a new semantic attribute domain by creating a the `domain.json` file and generating the attributes.


1. Create a new file in the `semanticConventions` direcotry. The file must be a `json` file.
```json
{
  "domain": "scottish",
  "content": {
    "propertyName": "mapcolonies.scottish",
    "kind": "clan",
    "description": "name of the clan",
    "deprecated": false,
    "subAttributes": {
      "straight": {
        "propertyName": "mapcolonies.scottish.straight",
        "kind": "straightAttributes",
        "description": "attributes related to straights",
        "deprecated": false,
        "subAttributes": {
          "Jimmy": {
            "propertyName": "mapcolonies.scottish.straight.jimmy",
            "deprecated": false,
            "description": "Jimmy the scottish straight cat"
          },
          "David": {
            "propertyName": "mapcolonies.scottish.straight.david",
            "deprecated": false,
            "description": "David the scottish straight cat"
          }
        }
      },
      "fold": {
        "propertyName": "mapcolonies.scottish.fold",
        "kind": "straightAttributes",
        "description": "attributes related to fold",
        "deprecated": true
      }
    }
  }
}
```

2. Run the validations to make sure the file created is valid.

```bash
npm run validate:attributes
```

3. Run attributes generation to create new ts modules for all defined domain.json files.

```bash
npm run generate:attributes
```

4. Check the created TypeScript files to make sure they are as you desired. 
They should look like this:
```typescript
/* eslint-disable */
/**
 * This file was automatically generated by @mapcolonies/telemetry npm package.
 * DO NOT MODIFY IT BY HAND. Instead, modify the source JSONSchema file,
 * and release new compiled package to regenerate this file.
 */

/**
* attributes related to fold
* @constant
* @deprecated Change to new attribute if this one was replaced 

*/
export const SCOTTISH_FOLD = 'mapcolonies.scottish.fold'

/**
* David the scottish straight cat
* @constant
*/
export const SCOTTISH_STRAIGHT_DAVID = 'mapcolonies.scottish.straight.david'

/**
* Jimmy the scottish straight cat
* @constant
*/
export const SCOTTISH_STRAIGHT_JIMMY = 'mapcolonies.scottish.straight.jimmy'

/**
* name of the clan
* @constant
*/
export const SCOTTISH_CONVENTIONS = {
  scottish: {
    fold: 'mapcolonies.scottish.fold',
    straight: {
      David: 'mapcolonies.scottish.straight.david',
      Jimmy: 'mapcolonies.scottish.straight.jimmy'
    }
  }
}
```

## Development

The Schema used to validate the json files and to create TypeScript types for the script usage, is defined and managed inside the repo - `schemas/attribute.schema.json`.

The schema files are have autocomplete support in VsCode. To change the schema and file associations check the `.vscode/settings.json`.
> [!IMPORTANT]
> After any change to the schema, you MUST re-generate the types using the following command:
> ```bash
> npm run generate:types
> ```

All the semantic convention scripts run before the build process of the package, as their only output are TypeScript files that are transpiled as part of the larger build process into javascript.

