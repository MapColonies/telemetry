# Telemetry
## Semantic Conventions
* This package goal is to provide flexible and easy to provide semantic conventions to be used for telemetry purposes across all of MapColonies services.
* It's based on OpenTelemetry [semantic-conventions](https://opentelemetry.io/docs/specs/semconv/).
* Each Domain defines its JSON file that describes the semantic conventions of the domain. The package handles the validation of the file and the generation of files for use in code.
* Support Javascript & Typescript.

> [!IMPORTANT]
> If OpenTelemetry already defined a value as part of their semantic conventions, use that and do not define a new one.
> <be>
> Define attributes should follow the Open Telemetry [semantic-convention naming concept](https://github.com/open-telemetry/semantic-conventions/blob/main/docs/messaging/messaging-spans.md#message)

## Example
Below are short examples of schema definition and domain.json files.

> [!NOTE]
> Schema is defined and managed inside the repo - no part of new domain definition
> In case of changing, should re-generate the auto generated types
> ```bash
> npm run generate:types
> ```

New domain creation based related to json-schema
```json
{
  "domain": "scottish",
  "content": {
    "propertyName": "mapcolonies.scottish",
    "kind": "clan",
    "description": "name of the clan",
    "deprecated": false,
    "subAttributes": {
      "straight": {
        "propertyName": "mapcolonies.scottish.straight",
        "kind": "straightAttributes",
        "description": "attributes related to straights",
        "deprecated": false,
        "subAttributes": {
          "Jimmy": {
            "propertyName": "mapcolonies.scottish.straight.jimmy",
            "deprecated": false,
            "description": "Jimmy the scottish straight cat"
          },
          "David": {
            "propertyName": "mapcolonies.scottish.straight.david",
            "deprecated": false,
            "description": "David the scottish straight cat"
          }
        }
      },
      "fold": {
        "propertyName": "mapcolonies.scottish.fold",
        "kind": "straightAttributes",
        "description": "attributes related to fold",
        "deprecated": true
      }
    }
  }
}
```
### Generate auto constants
Run validation to assert the new domain suite the json-schema definition

```bash
npm run validate:attributes
```

Run attributes generation to create new ts modules for all defined domain.json files.

```bash
npm run generate:attributes
```

#### Expected new module 'SCOTTISH_GENERATED_ATTRIBUTES.ts'
```typescript
/* eslint-disable */
/**
 * This file was automatically generated by @mapcolonies/telemetry npm package.
 * DO NOT MODIFY IT BY HAND. Instead, modify the source JSONSchema file,
 * and release new compiled package to regenerate this file.
 */

/**
* attributes related to fold
* @constant
* @deprecated Change to new attribute if this one was replaced 

*/
export const SCOTTISH_FOLD = 'mapcolonies.scottish.fold'

/**
* David the scottish straight cat
* @constant
*/
export const SCOTTISH_STRAIGHT_DAVID = 'mapcolonies.scottish.straight.david'

/**
* Jimmy the scottish straight cat
* @constant
*/
export const SCOTTISH_STRAIGHT_JIMMY = 'mapcolonies.scottish.straight.jimmy'

/**
* name of the clan
* @constant
*/
export const SCOTTISH_CONVENTIONS = {
  scottish: {
    fold: 'mapcolonies.scottish.fold',
    straight: {
      David: 'mapcolonies.scottish.straight.david',
      Jimmy: 'mapcolonies.scottish.straight.jimmy'
    }
  }
}

```
<br/>

## CI

> [!IMPORTANT]
> Validation and generation of semantic convention attributes occur automatically as part of pre-build stage.

```bash
npm run build
```

<br/>

## USAGE

1. After publishing the new package version with a new domain - how to use from package.
   
```bash 
npm i @map-colonies/telemetry
 ```

2. Import in the desired module.
 ```typescript
import { SCOTTISH_CONVENTIONS, SCOTTISH_FOLD } from '@map-colonies/telemetry/conventions';
console.log(SCOTTISH_CONVENTIONS.scottish.straight.David)
console.log(SCOTTISH_FOLD) // This will be marked with strikethrough
```

